async function searchIranketab(bookName) {
  try {
    // Send message to background script
    const response = await new Promise((resolve) => {
      chrome.runtime.sendMessage(
        { action: "searchIranketab", bookName },
        (response) => {
          resolve(response);
        }
      );
    });

    if (!response) {
      throw new Error("No response received from background script");
    }

    if (!response.success) {
      throw new Error(response.error || "Unknown error occurred");
    }

    // Create a temporary div to parse the HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(response.html, "text/html");

    // Extract search results
    const results = [];
    const bookElements = doc.querySelectorAll("a[href^='/book/']");

    if (bookElements.length === 0) {
      return results;
    }

    bookElements.forEach((element) => {
      const titleElement = element.querySelector(".text-primary");
      const authorElement = element.querySelector(".text-sm.text-default");
      const imageElement = element.querySelector("img");

      if (titleElement) {
        // Clean up the title text (remove icon)
        let titleText = titleElement.textContent.trim();
        if (titleText.includes("کتاب")) {
          titleText = titleText.replace("کتاب", "").trim();
        }

        // Fix URL to be absolute - ensure it points to iranketab.ir
        let url = element.getAttribute("href"); // Use getAttribute instead of href property
        url = "https://www.iranketab.ir" + url;

        // Get image URL if available
        let imageUrl = "";
        if (imageElement && imageElement.src) {
          imageUrl = imageElement.src;
          if (imageUrl.startsWith("/")) {
            imageUrl = "https://www.iranketab.ir" + imageUrl;
          } else if (!imageUrl.startsWith("http")) {
            imageUrl = "https://www.iranketab.ir/" + imageUrl;
          }
        }

        // Get author if available
        let author = "";
        if (authorElement) {
          author = authorElement.textContent.trim();
        }

        results.push({
          title: titleText,
          author: author,
          url: url,
          imageUrl: imageUrl,
          // Price will be fetched on product page, not available in search results
          price: "",
        });
      }
    });

    return results;
  } catch (error) {
    console.error("Error searching Iranketab:", error);
    throw error;
  }
}

// Make the function available globally
window.searchIranketab = searchIranketab;

// Example output
// {
//   "success": true,
//   "parsedData": {
//       "content": "\r\n\r\n    <div class=\"flex flex-col gap-3\">\r\n        <div class=\"flex justify-end items-center px-4\">\r\n            <a href=\"/result/بری-لیندون\" class=\"text-xs text-primary\">مشاهده همه نتایج</a>\r\n        </div>\r\n        <div class=\"flex flex-col gap-4\">\r\n                <a href=\"/book/54068-the-memoirs-of-barry-lyndon\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-book\"></i> بری لیندون</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\">ویلیام تکری</div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x200?pic=www.iranketab.ir/Images/ProductImages/Thumbs/055c8250fe234beda6f4fd68b42de590.jpg\" alt=\"بری لیندون  | ویلیام تکری\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/profile/621-william-thackeray\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-user\"></i> ویلیام تکری</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/ProfileImages/ac95c90cdae24678bbf7c32009860725.jpg\" alt=\"ویلیام تکری\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/320-the-finest-british-guardian-novels\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> برترین رمان های انگلیسی گاردین</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/d40225cf403d4bc394026c2b36ba2aa3.png\" alt=\"برترین رمان های انگلیسی گاردین\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/743-best-historical-fiction\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> فهرست برترین رمان های تاریخی</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/398a61062a5f4c458b2cab2a234d22df.png\" alt=\"فهرست برترین رمان های تاریخی\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/315-1840s\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> دهه 1840 میلادی</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/1a4fbb0bc0d942bea430a888e463d44e.png\" alt=\"دهه 1840 میلادی\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/737-the-big-read\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> فهرست برترین رمان ها در بریتانیا</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/56ff21d2b67c4ae99a70ee7a320348f4.png\" alt=\"فهرست برترین رمان ها در بریتانیا\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/profile/3219-mahmoud-goudarzi\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-user\"></i> محمود گودرزی (1356)</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/ProfileImages/a17c5ea41c8744c999161931ff108d02.jpg\" alt=\"محمود گودرزی (1356)\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/730-1001-books-you-must-read-before-you-die\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> 1001 رمانی که باید قبل از مرگ بخوانید</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/243d9c7812c64985b85ae36d1f16d048.png\" alt=\"1001 رمانی که باید قبل از مرگ بخوانید\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/985-the-best-selling-1400\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> پرفروش ترین های چاپ 1400</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/466033e9ee0e440fbc248725d51e3516.png\" alt=\"پرفروش ترین های چاپ 1400\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n        </div>\r\n    </div>\r\n",
//       "totalItems": 9
//   },
//   "html": "\r\n\r\n    <div class=\"flex flex-col gap-3\">\r\n        <div class=\"flex justify-end items-center px-4\">\r\n            <a href=\"/result/بری-لیندون\" class=\"text-xs text-primary\">مشاهده همه نتایج</a>\r\n        </div>\r\n        <div class=\"flex flex-col gap-4\">\r\n                <a href=\"/book/54068-the-memoirs-of-barry-lyndon\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-book\"></i> بری لیندون</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\">ویلیام تکری</div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x200?pic=www.iranketab.ir/Images/ProductImages/Thumbs/055c8250fe234beda6f4fd68b42de590.jpg\" alt=\"بری لیندون  | ویلیام تکری\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/profile/621-william-thackeray\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-user\"></i> ویلیام تکری</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/ProfileImages/ac95c90cdae24678bbf7c32009860725.jpg\" alt=\"ویلیام تکری\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/320-the-finest-british-guardian-novels\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> برترین رمان های انگلیسی گاردین</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/d40225cf403d4bc394026c2b36ba2aa3.png\" alt=\"برترین رمان های انگلیسی گاردین\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/743-best-historical-fiction\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> فهرست برترین رمان های تاریخی</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/398a61062a5f4c458b2cab2a234d22df.png\" alt=\"فهرست برترین رمان های تاریخی\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/315-1840s\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> دهه 1840 میلادی</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/1a4fbb0bc0d942bea430a888e463d44e.png\" alt=\"دهه 1840 میلادی\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/737-the-big-read\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> فهرست برترین رمان ها در بریتانیا</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/56ff21d2b67c4ae99a70ee7a320348f4.png\" alt=\"فهرست برترین رمان ها در بریتانیا\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/profile/3219-mahmoud-goudarzi\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-user\"></i> محمود گودرزی (1356)</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/ProfileImages/a17c5ea41c8744c999161931ff108d02.jpg\" alt=\"محمود گودرزی (1356)\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/730-1001-books-you-must-read-before-you-die\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> 1001 رمانی که باید قبل از مرگ بخوانید</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/243d9c7812c64985b85ae36d1f16d048.png\" alt=\"1001 رمانی که باید قبل از مرگ بخوانید\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n                <a href=\"/tag/985-the-best-selling-1400\"\r\n                   class=\"flex items-center gap-2 p-2 rounded hover:bg-default-100\">\r\n                    <div class=\"relative flex flex-col gap-2 w-full overflow-hidden\">\r\n                        <div class=\"relative flex flex-col gap-1 overflow-hidden\">\r\n\t\t\t\t\t\t\t<div class=\"truncate text-primary\"><i class=\"fa-solid fa-tag\"></i> پرفروش ترین های چاپ 1400</div>\r\n                            <div class=\"truncate text-xs text-default\"></div>\r\n                            <div class=\"text-sm text-default truncate\"></div>\r\n                        </div>\r\n                    </div>\r\n                    <img src=\"https://img.iranketab.ir/img/150x150?pic=www.iranketab.ir/Images/TagModule/466033e9ee0e440fbc248725d51e3516.png\" alt=\"پرفروش ترین های چاپ 1400\"\r\n                         class=\"rounded-md w-[64px] bg-default-200\" />\r\n                </a>\r\n        </div>\r\n    </div>\r\n"
// }
